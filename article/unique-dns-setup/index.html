<!doctype html><html lang=zh><head><title>独特的DNS配置 - ShiuxのBlog</title><meta charset=UTF-8><meta name=keywords content=""><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=5"><link rel="shortcut icon" href=/logo.svg type=image/x-icon><meta name=description content="众所周知，DNS的作用与电话簿类似，将人类可读的域名映射到机器可读IP地址、使人更方便地访问互联网。DNS是非常重要的互联网基础设施，对于改善上网冲浪的体验中的重要程度不容小觑。 避免不必要的DNS解析 如果想要通过优化DNS来改善自己的网络体验，第一步其实是避免不必要的DNS解析。 使用Fake IP避免本机DNS解析 对于不支持设置SOCKS&#x2F;HTTP(S)代理的软件，Surge&#x2F;Clash等"><meta property=og:type content=article><meta property=og:title content=独特的DNS配置><meta property=og:url content=https://blog.shiux.com/article/unique-dns-setup/index.html><meta property=og:site_name content=ShiuxのBlog><meta property=og:description content="众所周知，DNS的作用与电话簿类似，将人类可读的域名映射到机器可读IP地址、使人更方便地访问互联网。DNS是非常重要的互联网基础设施，对于改善上网冲浪的体验中的重要程度不容小觑。 避免不必要的DNS解析 如果想要通过优化DNS来改善自己的网络体验，第一步其实是避免不必要的DNS解析。 使用Fake IP避免本机DNS解析 对于不支持设置SOCKS&#x2F;HTTP(S)代理的软件，Surge&#x2F;Clash等"><meta property=og:locale content=zh_CN><meta property=og:image content=https://s1.ax1x.com/2023/02/17/pSqQy9K.png><meta property=og:image content=https://s1.ax1x.com/2023/02/17/pSqQ61O.png><meta property=og:image content=https://s1.ax1x.com/2023/02/17/pSqQfHA.png><meta property=og:image content=https://s1.ax1x.com/2023/02/17/pSqQHgS.png><meta property=og:image content=https://s1.ax1x.com/2023/02/17/pSqlCgU.png><meta property=article:published_time content=2020-02-23T11:22:04.000Z><meta property=article:modified_time content=2024-10-11T14:44:22.866Z><meta property=article:author content=Shiux><meta property=article:tag content=技巧><meta property=article:tag content=IP><meta property=article:tag content=DNS><meta property=article:tag content=MacOS><meta name=twitter:card content=summary><meta name=twitter:image content=https://s1.ax1x.com/2023/02/17/pSqQy9K.png><link rel=stylesheet href=/lib/fancybox/fancybox.css><link rel=stylesheet href=/lib/mdui_043tiny/mdui.css><link rel=stylesheet href="/lib/iconfont/iconfont.css?v=1728658055220"><link rel=stylesheet href="/css/style.css?v=1728658055220"><link rel=stylesheet href="/custom.css?v=1728658055220"><script src=/lib/mdui_043tiny/mdui.js async></script><script src=/lib/fancybox/fancybox.umd.js async></script><script src=/lib/lax.min.js async></script><script async src="/js/app.js?v=1728658055220"></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css><meta name=generator content="Hexo 7.3.0"></head><body class="nexmoe mdui-drawer-body-left"><div id=nexmoe-background><div class=nexmoe-bg style=background-image:url(https://www.dmoe.cc/random.php)></div><div class="mdui-appbar mdui-shadow-0"><div class=mdui-toolbar><a class="mdui-btn mdui-btn-icon mdui-ripple" mdui-drawer="{target: &#039;#drawer&#039;, swipe: true}" title=menu><i class="mdui-icon nexmoefont icon-menu"></i></a><div class=mdui-toolbar-spacer></div><a class="mdui-btn mdui-btn-icon" href=/ title=Shiux><img src=/logo.svg alt=Shiux></a></div></div></div><div id=nexmoe-header><div class="nexmoe-drawer mdui-drawer" id=drawer><div class="nexmoe-avatar mdui-ripple"><a href=/ title=Shiux><img src=/logo.svg alt=Shiux alt=Shiux></a></div><div class=nexmoe-count><div><span>文章</span>49</div><div><span>标签</span>36</div><div><span>分类</span>7</div></div><div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}"><a class="nexmoe-list-item mdui-list-item mdui-ripple false" href=/ title=回到首页><i class="mdui-list-item-icon nexmoefont icon-home"></i><div class=mdui-list-item-content>回到首页</div></a><a class="nexmoe-list-item mdui-list-item mdui-ripple false" href=/archive.html title=文章归档><i class="mdui-list-item-icon nexmoefont icon-container"></i><div class=mdui-list-item-content>文章归档</div></a><a class="nexmoe-list-item mdui-list-item mdui-ripple false" href=/about.html title=关于博主><i class="mdui-list-item-icon nexmoefont icon-info-circle"></i><div class=mdui-list-item-content>关于博主</div></a></div><div class=nexmoe-widget-wrap><div class="nexmoe-widget nexmoe-social"><a class=mdui-ripple href=https://github.com/shiucs/ target=_blank mdui-tooltip="{content: 'GitHub'}" style=color:#191717;background-color:rgba(25,23,23,.1)><i class="nexmoefont icon-github"></i> </a><a class=mdui-ripple href=https://www.zhihu.com/people/fungyua target=_blank mdui-tooltip="{content: '知乎'}" style=color:#1e88e5;background-color:rgba(30,136,229,.1)><i class="nexmoefont icon-zhihu"></i> </a><a class=mdui-ripple href=/atom.xml target=_blank mdui-tooltip="{content: 'RSS'}" style=color:#f78422;background-color:rgba(247,132,34,.1)><i class="nexmoefont icon-rss"></i></a></div></div><div class=nexmoe-widget-wrap><h3 class=nexmoe-widget-title>文章分类</h3><div class=nexmoe-widget><ul class=category-list><li class=category-list-item><a class=category-list-link href=/categories/Code/ >Code</a> <span class=category-list-count>20</span></li><li class=category-list-item><a class=category-list-link href=/categories/Guide/ >Guide</a> <span class=category-list-count>11</span></li><li class=category-list-item><a class=category-list-link href=/categories/Linux/ >Linux</a> <span class=category-list-count>5</span></li><li class=category-list-item><a class=category-list-link href=/categories/MacOS/ >MacOS</a> <span class=category-list-count>5</span></li><li class=category-list-item><a class=category-list-link href=/categories/NetWork/ >NetWork</a> <span class=category-list-count>2</span></li><li class=category-list-item><a class=category-list-link href=/categories/UX/ >UX</a> <span class=category-list-count>1</span></li><li class=category-list-item><a class=category-list-link href=/categories/Windows/ >Windows</a> <span class=category-list-count>5</span></li></ul></div></div><div class=nexmoe-widget-wrap><div id=randomtagcloud class="nexmoe-widget tagcloud nexmoe-rainbow"><a href=/tags/APP/ style=font-size:13.33px>APP</a> <a href=/tags/AdGuard/ style=font-size:11.67px>AdGuard</a> <a href=/tags/Aria2/ style=font-size:10px>Aria2</a> <a href=/tags/CentOS/ style=font-size:13.33px>CentOS</a> <a href=/tags/Cloud/ style=font-size:10px>Cloud</a> <a href=/tags/DNS/ style=font-size:10px>DNS</a> <a href=/tags/Docker/ style=font-size:10px>Docker</a> <a href=/tags/FastAPI/ style=font-size:10px>FastAPI</a> <a href=/tags/Git/ style=font-size:11.67px>Git</a> <a href=/tags/HTML/ style=font-size:11.67px>HTML</a> <a href=/tags/Hackintosh/ style=font-size:11.67px>Hackintosh</a> <a href=/tags/Hexo/ style=font-size:11.67px>Hexo</a> <a href=/tags/IP/ style=font-size:11.67px>IP</a> <a href=/tags/Issue/ style=font-size:11.67px>Issue</a> <a href=/tags/JavaScript/ style=font-size:15px>JavaScript</a> <a href=/tags/JetBrains/ style=font-size:10px>JetBrains</a> <a href=/tags/MacOS/ style=font-size:10px>MacOS</a> <a href=/tags/MySQL/ style=font-size:11.67px>MySQL</a> <a href=/tags/NGINX/ style=font-size:10px>NGINX</a> <a href=/tags/NextCloud/ style=font-size:11.67px>NextCloud</a> <a href=/tags/Nodejs/ style=font-size:15px>Nodejs</a> <a href=/tags/PHP/ style=font-size:13.33px>PHP</a> <a href=/tags/PIP/ style=font-size:10px>PIP</a> <a href=/tags/Powershell/ style=font-size:10px>Powershell</a> <a href=/tags/SQLAlchemy/ style=font-size:10px>SQLAlchemy</a> <a href=/tags/SSH/ style=font-size:10px>SSH</a> <a href=/tags/Spider/ style=font-size:18.33px>Spider</a> <a href=/tags/Ubuntu/ style=font-size:11.67px>Ubuntu</a> <a href=/tags/npm/ style=font-size:11.67px>npm</a> <a href=/tags/Code/ style=font-size:13.33px>代码</a> <a href=/tags/FrontEnd/ style=font-size:11.67px>前端</a> <a href=/tags/Consult/ style=font-size:16.67px>咨询</a> <a href=/tags/Skill/ style=font-size:20px>技巧</a> <a href=/tags/Note/ style=font-size:20px>笔记</a> <a href=/tags/Terminal/ style=font-size:15px>终端</a> <a href=/tags/Sources/ style=font-size:10px>软件源</a></div><script>for(var maxTagcloud=parseInt(17),tags_length=parseInt(36),tags_arr=[],i=0;i<tags_length;i++)tags_arr.push(i);tags_arr.sort(function(a,t){return.5<Math.random()?-1:1});for(var tags_arr=tags_arr.slice(0,maxTagcloud<tags_length?tags_length-maxTagcloud:0),tag_i=0;tag_i<tags_arr.length;tag_i++)document.getElementById("randomtagcloud").children[tags_arr[tag_i]].style.display="none"</script></div><div class=nexmoe-widget-wrap><h3 class=nexmoe-widget-title>一言</h3><div class=nexmoe-widget><ul class=hitokoto-box><li id=hitokoto_text_parent class=hitokoto-text hitokotocategory=""><a href=# id=hitokoto_text></a> <a href=# id=hitokoto_error_text style=display:none></a></li></ul></div></div><script>let hitokotoText=document.getElementById("hitokoto_text"),hitokotoErroText=document.getElementById("hitokoto_error_text"),hitokotoCategory=document.getElementById("hitokoto_text_parent").getAttribute("hitokotoCategory");window.addEventListener("load",function(){let t="https://v1.hitokoto.cn";hitokotoCategory&&(t+="?c="+hitokotoCategory),fetch(t).then(t=>t.json()).then(t=>{hitokotoText.innerText="「 "+t.hitokoto+" 」 from "+t.from,hitokotoText.href="https://hitokoto.cn/?uuid="+t.uuid}).catch(t=>{console.error(11,t),hitokotoText.style.display="none",hitokotoErroText.style.display="block"})})</script><div class=nexmoe-widget-wrap><h3 class=nexmoe-widget-title>文章归档</h3><div class=nexmoe-widget><ul class=archive-list><li class=archive-list-item><a class=archive-list-link href=/archives/2023/ >2023</a><span class=archive-list-count>9</span></li><li class=archive-list-item><a class=archive-list-link href=/archives/2022/ >2022</a><span class=archive-list-count>2</span></li><li class=archive-list-item><a class=archive-list-link href=/archives/2021/ >2021</a><span class=archive-list-count>17</span></li><li class=archive-list-item><a class=archive-list-link href=/archives/2020/ >2020</a><span class=archive-list-count>20</span></li><li class=archive-list-item><a class=archive-list-link href=/archives/2019/ >2019</a><span class=archive-list-count>1</span></li></ul></div></div><div class=nexmoe-widget-wrap><h3 class=nexmoe-widget-title>最新文章</h3><div class=nexmoe-widget><ul><li><a href=/article/windows-port-is-occupied/ >解决Windows电脑端口被占用问题</a></li><li><a href=/article/python-pip-issue/ >修改了Python安装目录的文件夹名称而无法使用pip的两种实用解决方法</a></li><li><a href=/article/python-fastapi-sqlalchemy/ >Python FastAPI框架配合SQLAlchemy操作Mysql数据库 增删改查</a></li><li><a href=/article/powershell-perfect-setup/ >Powershell完美配置</a></li><li><a href=/article/hackintosh-one-key-hidip/ >黑苹果一键HiDPI</a></li></ul></div></div><div class=nexmoe-copyright>&copy; 2024 Shiux Powered by <a href=http://hexo.io/ target=_blank>Hexo</a> & <a href=https://github.com/theme-nexmoe/hexo-theme-nexmoe target=_blank>Nexmoe</a></div></div></div><div id=nexmoe-content><div class=nexmoe-primary><div class=nexmoe-post><article><div class="nexmoe-post-cover absolute" style=padding-top:NaN%><img src=https://s1.ax1x.com/2023/02/17/pSbzwGV.png alt=独特的DNS配置 loading=lazy><h1>独特的DNS配置</h1></div><div class=nexmoe-post-meta><div class=nexmoe-rainbow><a class="nexmoefont icon-calendar-fill">2020年02月23日</a> <a class="nexmoefont icon-appstore-fill -link" href=/categories/NetWork/ >NetWork</a> <a><i class="nexmoefont icon-areachart"></i>约6.1k字</a> <a><i class="nexmoefont icon-time-circle-fill"></i>预计需要22分钟</a></div></div><p>众所周知，DNS的作用与电话簿类似，将人类可读的域名映射到机器可读IP地址、使人更方便地访问互联网。DNS是非常重要的互联网基础设施，对于改善上网冲浪的体验中的重要程度不容小觑。</p><h2 id=避免不必要的DNS解析>避免不必要的DNS解析</h2><p>如果想要通过优化DNS来改善自己的网络体验，第一步其实是避免不必要的DNS解析。</p><h3 id=使用Fake-IP避免本机DNS解析>使用Fake IP避免本机DNS解析</h3><p>对于不支持设置SOCKS/HTTP(S)代理的软件，Surge/Clash等软件一般选择通过TUN/TAP或转发redir透明网关接管网络请求，从而拿到原始的TCP/IP连接。</p><p>在POSIX规范下，执行网络请求需要先通过gethostbyname、getremoteaddr等操作系统提供的方法进行DNS解析，获取到IP地址以后发起连接；如果DNS解析不成功，网络请求就无从谈起了。因此绝大部分依赖TUN和TAP的某些软件都会接管系统DNS解析。接管DNS解析后随之而来的便是一系列问题：</p><ul><li>DNS污染：由于特殊的网络环境，通过你本机直接进行DNS解析得到的结果可能不可靠。</li><li>CDN优化：如果要访问的目标网站使用了CDN，最理想的结果是 距离代理服务器最近的CDN节点 - 代理服务器 - 你。如果你通过本机直接进行DNS解析，获取到的IP地址可能并不是距离你远端代理服务器 最近的CDN节点。</li></ul><p>由于常见的某些协议都运行在Layer 4上、支持封装域名；因此Surge/Clash等软件在转发流量时，都是封装目标域名，而不是目标域名在本机解析到的IP地址，从而规避DNS污染和实现CDN优化。</p><p>如果软件一旦决定将某个域名转发给远端代理服务器，远端代理服务器也需要对拿到的域名进行一次解析，在本机解析的IP地址其实没有起任何作用，白白浪费一个RTT。于是2001年四月，IETF通过了RFC3089，描述了一种网关通过接管DNS、返回Fake IP来建立TCP/IP链接的方法。简单的流程如下：</p><ul><li>代理网关接管本机的DNS解析</li><li>一个软件意图对一个域名发起网络请求，于是先通过DNS解析获取域名对应的IP</li><li>代理网关收到DNS解析请求后，不做任何DNS解析，而是直接返回一个保留IP地址（Fake IP）</li><li>发起网络请求的软件获取到Fake IP后，试图以Fake IP为目标发起网络请求</li><li>代理网关截获网络请求，通过目标的Fake IP反推出目标域名</li><li>代理网关将流量和目标域名使用某种协议重新封装后、转发给远端代理服务器</li></ul><p>不过在日常使用中，即使有了Fake IP也不能完全避免本机进行DNS解析。Surge/Clash使用Fake IP后，当且只当以下两种情况时会在本机进行DNS解析：</p><ul><li>目标域名需要使用DIRECT策略（即直连）、此时Surge/Clash需要得到真实的目标IP、不通过代理服务器直接发起连接</li><li>Surge/Clash遇到了基于IP分流的策略（如 IP-CIDR、IP-ASN、GEOIP、LAN 等），此时Surge/Clash需要得到一个IP用于匹配分流</li></ul><p>也就是说，如果Surge和Clash能够匹配到了一条域名规则、指示网络请求需要被转发给远端代理服务器，Surge和Clash便不会在本地进行DNS解析。因此在编写Surge和Clash（以及同类软件Shadowrocket、Quantumult(X)、Surfboard等）的规则时，将IP相关规则（IP-CIDR、IP-ASN、GEOIP等）放在其余的规则（DOMAIN、DST-PORT、SRC-PORT、PROTOCOL、URL-REGEX）的后面；除此以外，需要代理的域名的规则组越完善、Surge/Clash匹配到IP类规则的概率也就越低，需要本机DNS解析的次数也就越少。</p><h3 id=使用域名分流规则直接拦截广告>使用域名分流规则直接拦截广告</h3><p>不论是去广告Hosts还是AdGuardHome等解决方案，本质上都是在DNS解析环节拦截域名；由于DNS的局限性，这类解决方案只能拦截完整的广告域名，不能拦截某一个域名下的具体URL，因此要么不够强力、要么误杀严重，不能取代专业的浏览器去广告插件（如ADBlock Plus、AdGuard for Chrome）和去广告软件（如AdGuard for Android）。</p><p>除此以外，由于Surge/Clash等支持使用域名规则进行分流的软件也都提供了对REJECT策略的支持（Surge还额外支持两种特殊的REJECT策略：不回复任何数据包、任由链接自行超时的REJECT-DROP，和返回空白1像素GIF图像文件的TINY-GIF）。因此，我们可以编写域名规则拦截广告请求、彻底杜绝被拦截域名的DNS解析、加快阻断。</p><blockquote><p>目前Surge支持DOMAIN-SET格式，可以在一个配置文件里记录数十万条域名，而不会内存泄漏或崩溃；Clash、Quantumult(X) 的域名规则可能不支持上万级别数量的域名、强行导入可能导致内存泄漏或Panic；Surfboard虽然完全兼容Surge的DOMAIN-SET格式，但是可能存在优化程度不够、达不到Surge同等速度和效率。<br>建议先对有关软件进行测试，如果不能很好的处理大量域名规则的，仍然可以使用AdGuardHome作为去广告的替代。</p></blockquote><h2 id=中场休息：递归DNS是怎么知道哪个CDN节点距离我最近的？>中场休息：递归DNS是怎么知道哪个CDN节点距离我最近的？</h2><p>先暂时抛开对我的DNS配置的介绍，简单谈谈递归DNS（Local DNS）是如何实现「CDN优化」的。</p><p>假设你的宽带IP是<code>114.5.1.4</code>，你现在试图访问一个使用了阿里云 CDN 的网站<code>alicdn.example.com</code>、接入CDN的方式是CNAME到<code>alicdn.example.com.w.alikunlun.com</code>。</p><blockquote><p>注意，为了节省篇幅，在接下来的描述中，我刻意省去了Local DNS向Root DNS查询<code>com</code>和<code>example.com</code>的权威DNS的过程。如果想要了解完整的DNS查询过程，可以阅读由Cloudflare编写的<a target=_blank rel=noopener href=https://www.cloudflare.com/learning/dns/what-is-dns/ >What is DNS? | How DNS works</a>。</p></blockquote><h3 id=运营商DNS>运营商DNS</h3><p>一开始，你使用的是由运营商下发给你的运营商DNS，假设运营商的递归DNS的IP是<code>1.2.3.4</code>，于是：</p><ul><li>你向<code>1.2.3.4</code>发起DNS查询：请问<code>alicdn.example.com</code>的解析结果是什么？</li><li><code>1.2.3.4</code>问<code>example.com</code>的权威DNS查询：<code>alicdn.example.com</code>的解析结果是什么？</li><li><code>example.com</code>的权威DNS告诉<code>1.2.3.4</code>：<code>alicdn.example.com</code>用CNAME指向了<code>alicdn.example.com.w.alikunlun.com</code>。</li><li>于是<code>1.2.3.4</code>把结果返回给你：<code>alicdn.example.com</code>用CNAME指向了<code>alicdn.example.com.w.alikunlun.com</code></li><li>你问<code>1.2.3.4</code>：请问<code>alicdn.example.com.w.alikunlun.com</code>的解析结果是什么？</li><li><code>1.2.3.4</code>问<code>alikunlun.com</code>的权威DNS：<code>alicdn.example.com.w.alikunlun.com</code>的解析结果是什么？</li><li><code>alikunlun.com</code>是阿里云CDN的域名，阿里的权威DNS开始找：地理位置最接近<code>1.2.3.4</code>的CDN节点是哪些？有<code>19.19.8.10</code>。</li><li><code>alikunlun.com</code>告诉<code>1.2.3.4</code>：<code>alicdn.example.com.w.alikunlun.com</code>解析到了<code>19.19.8.10</code>。</li><li><code>1.2.3.4</code>把结果返回给你：<code>alicdn.example.com.w.alikunlun.com</code>解析到了<code>19.19.8.10</code>。</li></ul><p><img onerror=imgOnError(this) data-fancybox=gallery src=https://s1.ax1x.com/2023/02/17/pSqQy9K.png alt=运营商DNS data-caption=运营商DNS loading=lazy></p><p>因此，阿里云CDN并不是返回「最适合你」的CDN节点IP，而是返回「最适合这个运营商DNS」的CDN节点IP。只不过由于运营商DNS一般都距离你很近，所以也可以把这个结果当作是「最适合你」的CDN节点IP。</p><h3 id=公共DNS>公共DNS</h3><p>再后来，你听说南京信风提供的公共递归DNS <code>114.114.114.114</code>很有名，于是你手动将你的DNS设置为<code>114.114.114.114</code>。</p><p><code>114.114.114.114</code>是一个Anycast IP，即一个IP能够对应不同区域、不同ISP的多个数据中心、多台服务器。截止到本文写就，南京信风仅在江苏南京的 电信、联通、移动 和 美国伊利诺伊州芝加哥的Cogent广播了<code>114.114.114.114</code>，也就是说<code>114.114.114.114</code>仅对应到了这两地的服务器节点。一般的，国内的用户连接<code>114.114.114.114</code>，都是访问位于江苏南京的节点。</p><p>你通过<code>114.114.114.114</code>和通过运营商DNS获取<code>alicdn.example.com</code>的解析结果的过程大同小异，区别在于这一次，<code>alikunlun.com</code>并不会试图返回最适合<code>1.2.3.4</code>（你的运营商DNS）的CDN节点，而是试图返回最适合江苏南京的CDN节点。</p><p>由于中国复杂的互联网环境和封闭的网络基础设施建设，很难将Anycast覆盖到中国30余省市的十数个主流运营商、如上文所说，南京信风的<code>114.114.114.114</code>在国内甚至只有一个节点、只能覆盖三个运营商；即使是腾讯云DNSPod和阿里的公共DNS，在国内也只有不到10个节点。</p><p><img onerror=imgOnError(this) data-fancybox=gallery src=https://s1.ax1x.com/2023/02/17/pSqQ61O.png alt=公用DNS data-caption=公用DNS loading=lazy></p><p>因此，在国内使用公共DNS，不仅不能够优化CDN，反而还会劣化CDN。也是因为同一个原因，运营商要劫持你的DNS查询，避免因为你的DNS设置不当、反而投诉运营商的网络速度慢、差。</p><p>与此同时，公共DNS为了解决少数Anycast节点无法对应到全国30余省市数十个运营商的问题，另辟蹊径想出了一个新的方案：</p><h3 id=多出口IP的公共DNS>多出口IP的公共DNS</h3><p>有的公共DNS除了在全国设立Anycast节点、负责接收DNS查询以外，还在全国30余省市均部署了额外的服务器（称作「DNS出口服务器」）。这些DNS出口服务器不会直接接收来自终端用户的DNS查询，而是Anycast节点接收到终端用户的DNS查询后，转交给DNS出口服务器再进行解析：</p><ul><li>你（<code>114.5.1.4</code>）向<code>233.5.5.5</code>发起查询：请问<code>alicdn.example.com</code>的解析结果是什么？</li><li><code>223.5.5.5</code>的众多Anycast节点中的一个收到了你的查询、开始寻找：我在全国部署的上百个DNS出口服务器中，哪一个是距离<code>114.5.1.4</code>最近的？</li><li>223.5.5.5 将DNS查询转交给距离你最近的 DNS 出口服务器（称作「DNS 出口 A」）。</li><li>DNS出口A问alikunlun.com的权威DNS：<code>alicdn.example.com.w.alikunlun.com</code>的解析结果是什么？</li><li>阿里云CDN开始找：地理位置最接近A的CDN节点都是哪些？</li><li><code>alikunlun.com</code>告诉A：<code>alicdn.example.com.w.alikunlun.com</code>解析到了这些IP。</li><li>A告诉<code>223.5.5.5</code>：<code>alicdn.example.com.w.alikunlun.com</code>解析到了这些IP。</li><li><code>223.5.5.5</code>告诉你：<code>alicdn.example.com.w.alikunlun.com</code>解析到了这些IP。</li></ul><p><img onerror=imgOnError(this) data-fancybox=gallery src=https://s1.ax1x.com/2023/02/17/pSqQfHA.png alt=多出口IP的公共DNS data-caption=多出口IP的公共DNS loading=lazy></p><p>这样，虽然接收到你查询的公共DNS的Anycast节点不一定距离你非常非常近，但是最终向权威DNS发起查询的，却是距离你尽可能近的「DNS出口服务器」，因此得到的「最适合DNS出口服务器」的CDN节点IP、也是最适合你的。</p><h3 id=支持EDNS-Client-Subnet的公共DNS>支持EDNS Client Subnet的公共DNS</h3><p>为了解决权威DNS难以根据终端用户的真实IP返回最适合用户的CDN节点的问题，IETF通过了<a target=_blank rel=noopener href=https://datatracker.ietf.org/doc/html/rfc7871>RFC7871</a>，即EDNS Client Subnet（ECS）。RFC7871定义了在DNS查询时，用户可以指定一个IP网段，权威DNS可以据此返回最适合这个IP网段的CDN节点：</p><ul><li>你（<code>114.5.1.4</code>）问支持ECS的公共DNS<code>119.29.29.29</code>：我是<code>114.5.1.0/24</code>，请问<code>alicdn.example.com.w.alikunlun.com</code>的解析结果是什么？</li><li><code>119.29.29.29</code>问<code>alikunlun.com</code>的权威DNS：<code>114.5.1.0/24</code>在问<code>alicdn.example.com.w.alikunlun.com</code>的解析结果是什么？</li><li>阿里云CDN开始找：地理位置最接近<code>114.5.1.0/24</code>的CDN节点都是哪些？</li><li><code>alikunlun.com</code>告诉<code>119.29.29.29</code>：<code>alicdn.example.com.w.alikunlun.com</code>解析到了这些IP。</li><li><code>119.29.29.29</code>把结果返回给你：<code>alicdn.example.com.w.alikunlun.com</code>解析到了这些IP。</li></ul><p><img onerror=imgOnError(this) data-fancybox=gallery src=https://s1.ax1x.com/2023/02/17/pSqQHgS.png alt="支持EDNS Client Subnet的公共DNS" data-caption="支持EDNS Client Subnet的公共DNS" loading=lazy></p><p>虽然ECS解决了权威DNS无法获取用户真实IP的问题，但是在实践中仍然存在一些困难：</p><ul><li>使用ECS有可能泄漏用户的隐私信息，一些公共DNS（如Cloudflare的<code>1.1.1.1</code>和<code>1.0.0.1</code>）因此拒绝提供ECS支持。</li><li>在<a target=_blank rel=noopener href=https://datatracker.ietf.org/doc/html/rfc7871#section-11.2>RFC7871的11.2章节</a>中提到了一种针对ECS的攻击（即Birthday Attack），因此当DNS请求/响应中的ECS信息不完整时、需要彻底忽略ECS，降级回传统DNS查询。</li><li>使用ECS会降低递归DNS的性能、甚至可以被用于发动针对递归DNS的攻击：以前一个递归DNS可以为所有人缓存同一个CDN节点IP，现在却需要为每个人缓存不同的CDN节点IP。<a target=_blank rel=noopener href=https://datatracker.ietf.org/doc/html/rfc7871#section-11.3>RFC7871的11.3章节</a>也因此指出，并非所有的递归DNS都需要支持ECS。</li><li>ECS需要从用户、到递归DNS、到权威DNS全链路均提供支持才能生效。虽然在<a target=_blank rel=noopener href=https://dnsflagday.net/ >DNSFlagDay</a>的大力推动下，绝大部分权威DNS已经支持ECS，但在递归DNS中ECS的普及率仍然不容乐观。</li></ul><hr><p>在补充介绍了递归DNS是如何优化CDN结果后，不难得出结论：</p><ul><li>需要被代理的域名、<strong>必须在远端代理服务器上进行解析</strong>、才能得到最合适的解析结果。</li><li>在本地对需要代理的域名进行DNS解析，只不过是为了让Surge/Clash等软件能够基于IP分流（Surge/Clash的TUN/TAP会直接返回Fake IP、本地 DNS解析的结果根本不会暴露给外部）罢了。本地DNS解析的结果不需要很精确，<strong>建议牺牲准确度换更快的速度。</strong></li><li>为了能够让被代理的域名在远端服务器上解析，<strong>在通过某种协议将代理请求发送给远端代理服务器时，必须直接封装该网络请求的域名。</strong></li><li>使用Surge/Clash等软件后，<strong>完全无需使用dnsproxy或dns2socks转发本地DNS查询。代理此类DNS查询不仅没有必要，反而会导致延迟升高、影响上网体验。</strong></li></ul><h2 id=正确配置SmartDNS>正确配置SmartDNS</h2><blockquote><p>SmartDNS是一个运行在本地的DNS服务器，它接受来自本地客户端的DNS查询请求，然后从多个上游DNS服务器获取DNS查询结果，并将访问速度最快的结果返回给客户端，以此提高网络访问速度。SmartDNS同时支持指定特定域名IP地址，能够以极高的性能进行匹配，可用于过滤广告或分流。</p></blockquote><p>由于SmartDNS的极致性能和强大特性，以及「提高网络访问速度」的功能，许多YouTube视频和教程文档都将其奉若神明、称为一切的解药。然而事实上，如果不经过仔细的配置，SmartDNS不仅不能起到预期的效果，反而还会导致负优化。</p><p>如果一个网络请求将会被封装转发给远端代理服务器、会在远端代理服务器进行DNS解析，因此在本机进行的DNS解析得到的结果是没有任何意义的。因此，需要被代理的域名，并不在乎能否得到延时最低的IP，<strong>只需要不干扰Surge/Clash等软件的IP分流规则即可，无需非常精确。</strong></p><blockquote><p>不需要对SmartDNS产生的DNS查询请求和测速握手进行代理。将DNS查询转发给远端代理服务器会大幅增加DNS解析用时、影响上网体验！</p></blockquote><p>因此，需要被代理的域名不需要进行测速——测速不仅浪费一个RTT，而且ISP和其它中间人可能会记录你的ICMP或TCP握手行为。除此以外，考虑到绝大部分递归DNS（Local DNS）都可能存留日志用作各种用途（如下图所示的「中国科学技术大学USTC校园网DNS最近10分钟查询统计」），需要被代理的域名也最好不要选用位于国内的递归DNS作为上游。</p><p><img onerror=imgOnError(this) data-fancybox=gallery src=https://s1.ax1x.com/2023/02/17/pSqlCgU.png alt=最近10分钟查询统计 data-caption=最近10分钟查询统计 loading=lazy></p><h3 id=中场休息：SmartDNS是如何避免因测速导致DNS解析过慢的>中场休息：SmartDNS是如何避免因测速导致DNS解析过慢的</h3><p>第二个中场休息环节，这次简单讲讲 SmartDNS 的工作原理。</p><p>有一些人认为，SmartDNS配置了数十个上游，需要对上游返回的每一个IP都进行测速，反而严重影响DNS解析速度。但是实际使用SmartDNS后，并没有出现DNS解析过慢的情况。这是因为SmartDNS早就考虑到了测速与延时的问题、并进行了相关的优化。SmartDNS在首次DNS解析请求时，会同时向所有上游发起并发查询；一旦有一个上游返回了结果，SmartDNS就会对这第一个返回的结果进行测速，得到其中延时最低的IP，将其返回给用户、设置TTL为10；与此同时，SmartDNS仍然会等待剩余上游返回结果、异步进行测速，直到所有上游都返回了结果（或超时）、SmartDNS将所有的IP都进行测速以后，才会得到最优IP：</p><ul><li>假设我们向SmartDNS解析一个域名<code>example.com</code>，由于没有命中SmartDNS的缓存，因此不得不向上游获取结果。</li><li>SmartDNS同时向上游A、B、C发起查询请求</li><li>假设上游B最先返回了查询结果，查询结果包含了三个IP：<code>114.5.1.4</code>、<code>11.45.1.4</code>和<code>19.19.8.10</code>。</li><li>SmartDNS立刻开始对这三个IP进行测速。假设测得延时最低的IP是<code>11.45.1.4</code></li><li>SmartDNS会立刻返回<code>11.45.1.4</code>给客户端，同时设置TTL为10（即指示<code>11.45.1.4</code>只应该在客户端被缓存10秒中）</li><li>在接下来10秒内，客户端都会使用都会使用<code>11.45.1.4</code>来处理发往<code>example.com</code>的网络连接；与此同时SmartDNS仍然在等待上游A和C的结果。</li><li>一旦上游A和C的查询结果也都返回，SmartDNS会把上游A、B、C的结果进行汇总去重、重新测速，最终得到最快的那个IP。</li><li>由于SmartDNS有着非常严格的超时设置，因此上述「等待剩余上游结果并分别进行测速」步骤不会超过10秒。</li><li>等到10秒过去、客户端再次向SmartDNS查询<code>example.com</code>时，SmartDNS才会返回最快的IP、并设置一个「正确」的TTL。</li></ul><p>总而言之，SmartDNS首先会尽快返回一个「次优」的IP、要求客户端仅在接下来10秒钟内使用「次优」的IP，之后SmartDNS就能返回「最优」的IP。</p><blockquote><p>不过正如我在前文所说，Surge支持针对DNS返回的多个IP同时进行握手、并使用最先完成握手的TCP进行后续请求（丢弃其余的TCP握手），因此Surge使用的IP一定是延时最低的、而且能够跳过出现故障的IP；而且Surge复用了并发握手时的TCP连接进行后续请求，因此延时比SmartDNS「先测速、后返回IP」更低。<br>因此在搭配Surge使用时，上游DNS不需要自带测速；最好是能合并多个上游返回的结果，将多个上游返回的一大堆IP全部喂给Surge、让其并发握手。我给SmartDNS开了<a target=_blank rel=noopener href=https://github.com/pymumu/smartdns/issues/994>对应的Feature Request</a>，感兴趣的可以关注一下。</p></blockquote><h3 id=在SmartDNS中使用dnsmasq-china-list进行分流>在SmartDNS中使用dnsmasq-china-list进行分流</h3><p><a target=_blank rel=noopener href=https://github.com/felixonmars/dnsmasq-china-list>felixonmars/dnsmasq-china-list</a>是一组开源的，覆盖了绝大部分中国大陆的域名的dnsmasq配置文件，也可以通过预定义的<code>Makefile</code>生成供unbound、bind9、dnscrypt-proxy、SmartDNS、AdGuardHome、coredns使用的配置文件。截至本文写就，<code>dnsmasq-china-list</code>已经收录了65743个域名。满足以下任意两条规则之一的域名即会被收录到列表中：</p><ul><li>是<code>.cn</code>后缀的域名（包括<code>.edu.cn</code>、<code>.gov.cn</code>、<code>.org.cn</code>、<code>.ac.cn</code>等）</li><li>满足以下两条规则中任意一条的、非<code>.cn</code>后缀的域名：<ul><li>域名使用的权威DNS（Authoritative DNS）拥有位于中国大陆境内的节点</li><li>通过位于中国大陆境内的递归DNS解析时，解析得到的IP位于中国大陆境内</li></ul></li></ul><p>如果需要设置SmartDNS针对指定域名使用与默认配置不同的上游进行解析，可以使用nameserver，如下所示：</p><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line><span class=attr>nameserver</span> <span class=string>/example.cn/domestic</span></span><br></pre></td></tr></table></figure><p>如果需要设置SmartDNS针对指定域名不使用默认配置的上游、且采用与默认不同的测速方式，需要使用<code>domain-rules</code>，如下所示：</p><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line><span class=attr>domain-rules</span> <span class=string>/example.cn/ -speed-check-mode tcp:80 -nameserver domestic</span></span><br></pre></td></tr></table></figure><p><code>dnsmasq-china-list</code>预定义的<code>Makefile</code>同时支持生成上述两种配置格式的文件。使用下述命令可以生成使用<code>nameserver</code>的配置条目：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>make SERVER=domestic smartdns</span><br></pre></td></tr></table></figure><p>我给<code>dnsmasq-china-list</code>开了PR（<a target=_blank rel=noopener href=https://github.com/felixonmars/dnsmasq-china-list/pull/381>felixonmars/dnsmasq-china-list#381</a>）且已经被合并，现在已经可以生成使用<code>domain-rules</code>的配置条目：</p><figure class="highlight bash"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>make SERVER=domestic SMARTDNS_SPEEDTEST_MODE=tcp:80 smartdns-domain-rules</span><br></pre></td></tr></table></figure><blockquote><p>注意，你可能需要安装<code>make</code>才可以使用上述命令。在macOS上，<code>make</code>包含在Xcode Command Line Tools之中。</p></blockquote><h3 id=配置-SmartDNS-上游和仅测速国内域名>配置 SmartDNS 上游和仅测速国内域名</h3><p>如前文所说，在本地解析需要被代理的域名时，不需要测速、也不一定要绝对准确，只需要解析得到的IP不会干扰Surge/Clash分流即可；只将国内的递归DNS作为上游解析国内直连域名，也只对其进行测速。因此，我们使用「白名单」策略，默认解析不测速、不使用国内递归DNS作为上游。</p><p>首先需要禁用SmartDNS全局的测速设置：</p><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line><span class=attr>speed-check-mode</span> <span class=string>none</span></span><br></pre></td></tr></table></figure><p>然后设置两组上游DNS：默认的一组不位于中国大陆境内的递归DNS；另一组位于中国大陆境内的递归DNS，仅用于解析<code>dnsmasq-china-list</code>列表中的域名：</p><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre></td><td class=code><pre><span class=line><span class=comment># ----- Default Group -----</span></span><br><span class=line><span class=comment># 默认使用的上游 DNS 组</span></span><br><span class=line><span class=comment># OpenDNS 非常规 443 端口、支持 TCP 查询</span></span><br><span class=line><span class=attr>server-tcp</span> <span class=string>208.67.220.220:443</span></span><br><span class=line><span class=comment># OpenDNS 的 IP DoH</span></span><br><span class=line><span class=attr>server-https</span> <span class=string>https://146.112.41.2/dns-query</span></span><br><span class=line><span class=comment># TWNIC 的 IP DoH</span></span><br><span class=line><span class=attr>server-https</span> <span class=string>https://101.101.101.101/dns-query</span></span><br><span class=line><span class=comment># 你也可以配置其它 DNS 作为上游</span></span><br><span class=line><span class=comment></span></span><br><span class=line><span class=comment># ----- Domestic Group: domestic -----</span></span><br><span class=line><span class=comment># 仅用于解析 dnsmasq-china-list 列表中的域名</span></span><br><span class=line><span class=comment># 腾讯 DNSPod IP DoT</span></span><br><span class=line><span class=attr>server-tls</span> <span class=string>1.12.12.12:853 -group domestic -exclude-default-group</span></span><br><span class=line><span class=attr>server-tls</span> <span class=string>120.53.53.53:853 -group domestic -exclude-default-group</span></span><br><span class=line><span class=comment># 阿里 IP DoT</span></span><br><span class=line><span class=attr>server-tls</span> <span class=string>223.5.5.5:853 -group domestic -exclude-default-group</span></span><br><span class=line><span class=attr>server-tls</span> <span class=string>223.6.6.6:853 -group domestic -exclude-default-group</span></span><br><span class=line><span class=comment># 114 DNS、使用 TCP 查询</span></span><br><span class=line><span class=attr>server-tcp</span> <span class=string>114.114.114.114 -group domestic -exclude-default-group</span></span><br><span class=line><span class=attr>server-tcp</span> <span class=string>114.114.115.115 -group domestic -exclude-default-group</span></span><br><span class=line><span class=comment># CNNIC 公共 DNS、仅支持 UDP 查询</span></span><br><span class=line><span class=attr>server</span> <span class=string>1.2.4.8 -group domestic -exclude-default-group</span></span><br><span class=line><span class=attr>server</span> <span class=string>210.2.4.8 -group domestic -exclude-default-group</span></span><br></pre></td></tr></table></figure><p>其中，设置有<code>-exclude-default-group</code>的上游DNS默认不会被使用，仅当<code>domain-rules</code>或<code>nameserver</code>配置明确指定时使用。</p><blockquote><p>你可能注意到，我的配置中添加了CNNIC（中国互联网络信息中心）的公共DNS。这是考虑到CNNIC的公共DNS节点质量较差、出口IP位置稀少、基本没有针对CDN做任何优化（截至本文写就，<code>1.2.4.8</code>的Anycast仅在浙江杭州阿里云和香港Zenlayer广播路由，<code>210.2.4.8</code>的Anycast仅在 北京联通广播路由）。所以，一般情况下，只有CNNIC的公共DNS<strong>一定不能</strong>返回距离我位置最近的CDN节点（其余的公共DNS基本都会返回给我最优的CDN节点）。<br>设想一下，除CNNIC外、大部分公共DNS都会尽可能返回距离我本地运营商最近的、最优的CDN节点；由于SmartDNS的测速和优选，CNNIC返回的非最优CDN节点一般会被忽略。然而，假如距离我最近的CDN节点出现故障，只有CNNIC能够给我返回不一样的CDN节点、能够响应SmartDNS测速，因此我能够使用并非最优、但是可用的CDN节点「救急」、不至于直接「断网」。<br>简单来说，就是因为CNNIC公共DNS<strong>能够非常稳定地提供质量最差的递归DNS服务、不会间歇发生解析质量好转</strong>，才得以入选。</p></blockquote><p>最后，引入前文由<code>dnsmasq-china-list</code>生成的<code>domain-rules</code>配置文件：</p><figure class="highlight properties"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line><span class=attr>conf-file</span> <span class=string>/path/to/dnsmasq-china-list/accelerated-domains.china.domain.smartdns.conf</span></span><br><span class=line><span class=attr>conf-file</span> <span class=string>/path/to/dnsmasq-china-list/apple.china.domain.smartdns.conf</span></span><br></pre></td></tr></table></figure></article><div class="nexmoe-post-meta nexmoe-rainbow"><a class="nexmoefont icon-tag-fill -none-link" href=/tags/DNS/ rel=tag>DNS</a> <a class="nexmoefont icon-tag-fill -none-link" href=/tags/IP/ rel=tag>IP</a> <a class="nexmoefont icon-tag-fill -none-link" href=/tags/MacOS/ rel=tag>MacOS</a> <a class="nexmoefont icon-tag-fill -none-link" href=/tags/Skill/ rel=tag>技巧</a></div><script async src="/js/copy-codeblock.js?v=1728658054739"></script><div class=nexmoe-post-footer><script src=https://giscus.app/client.js data-repo=fungyua/blog-comments data-repo-id="MDEwOlJlcG9zaXRvcnk0MDQ0NTY2OTQ=" data-category=Comments data-category-id=DIC_kwDOGBuE9s4CTUfb data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=zh-CN crossorigin=anonymous async></script></div></div></div><div class=nexmoe-post-right><div class=nexmoe-fixed><div class=nexmoe-tool><button class="mdui-fab catalog" style=overflow:unset><i class="nexmoefont icon-i-catalog"></i><div class=nexmoe-toc><ol class=toc><li class="toc-item toc-level-2"><a class=toc-link href=#%E9%81%BF%E5%85%8D%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84DNS%E8%A7%A3%E6%9E%90><span class=toc-number>1.</span> <span class=toc-text>避免不必要的DNS解析</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%BD%BF%E7%94%A8Fake-IP%E9%81%BF%E5%85%8D%E6%9C%AC%E6%9C%BADNS%E8%A7%A3%E6%9E%90><span class=toc-number>1.1.</span> <span class=toc-text>使用Fake IP避免本机DNS解析</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%BD%BF%E7%94%A8%E5%9F%9F%E5%90%8D%E5%88%86%E6%B5%81%E8%A7%84%E5%88%99%E7%9B%B4%E6%8E%A5%E6%8B%A6%E6%88%AA%E5%B9%BF%E5%91%8A><span class=toc-number>1.2.</span> <span class=toc-text>使用域名分流规则直接拦截广告</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E4%B8%AD%E5%9C%BA%E4%BC%91%E6%81%AF%EF%BC%9A%E9%80%92%E5%BD%92DNS%E6%98%AF%E6%80%8E%E4%B9%88%E7%9F%A5%E9%81%93%E5%93%AA%E4%B8%AACDN%E8%8A%82%E7%82%B9%E8%B7%9D%E7%A6%BB%E6%88%91%E6%9C%80%E8%BF%91%E7%9A%84%EF%BC%9F><span class=toc-number>2.</span> <span class=toc-text>中场休息：递归DNS是怎么知道哪个CDN节点距离我最近的？</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E8%BF%90%E8%90%A5%E5%95%86DNS><span class=toc-number>2.1.</span> <span class=toc-text>运营商DNS</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%85%AC%E5%85%B1DNS><span class=toc-number>2.2.</span> <span class=toc-text>公共DNS</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%A4%9A%E5%87%BA%E5%8F%A3IP%E7%9A%84%E5%85%AC%E5%85%B1DNS><span class=toc-number>2.3.</span> <span class=toc-text>多出口IP的公共DNS</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%94%AF%E6%8C%81EDNS-Client-Subnet%E7%9A%84%E5%85%AC%E5%85%B1DNS><span class=toc-number>2.4.</span> <span class=toc-text>支持EDNS Client Subnet的公共DNS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class=toc-link href=#%E6%AD%A3%E7%A1%AE%E9%85%8D%E7%BD%AESmartDNS><span class=toc-number>3.</span> <span class=toc-text>正确配置SmartDNS</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%B8%AD%E5%9C%BA%E4%BC%91%E6%81%AF%EF%BC%9ASmartDNS%E6%98%AF%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E5%9B%A0%E6%B5%8B%E9%80%9F%E5%AF%BC%E8%87%B4DNS%E8%A7%A3%E6%9E%90%E8%BF%87%E6%85%A2%E7%9A%84><span class=toc-number>3.1.</span> <span class=toc-text>中场休息：SmartDNS是如何避免因测速导致DNS解析过慢的</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E5%9C%A8SmartDNS%E4%B8%AD%E4%BD%BF%E7%94%A8dnsmasq-china-list%E8%BF%9B%E8%A1%8C%E5%88%86%E6%B5%81><span class=toc-number>3.2.</span> <span class=toc-text>在SmartDNS中使用dnsmasq-china-list进行分流</span></a></li><li class="toc-item toc-level-3"><a class=toc-link href=#%E9%85%8D%E7%BD%AE-SmartDNS-%E4%B8%8A%E6%B8%B8%E5%92%8C%E4%BB%85%E6%B5%8B%E9%80%9F%E5%9B%BD%E5%86%85%E5%9F%9F%E5%90%8D><span class=toc-number>3.3.</span> <span class=toc-text>配置 SmartDNS 上游和仅测速国内域名</span></a></li></ol></li></ol></div></button> <a href=#nexmoe-content class="backtop toc-link" aria-label="Back To Top" title=top><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a></div></div></div></div><div id=nexmoe-footer><!--!--></div><div id=nexmoe-search-space><div class=search-container><div class=search-header><div class=search-input-container><input class=search-input type=text placeholder=搜索 oninput=sinput()></div><a class=search-close onclick=sclose()>×</a></div><div class=search-body></div></div></div><div><script async src="https://www.googletagmanager.com/gtag/js?id=G-9MEQVE108T"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-9MEQVE108T")</script></div></body></html>